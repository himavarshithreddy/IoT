<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Live IoT Data</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: #0a0a0a;
    min-height: 100vh;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 15px;
  }
  
  h2 {
    font-size: clamp(22px, 5vw, 28px);
    font-weight: 600;
    margin-bottom: 8px;
    color: #ffffff;
    text-align: center;
  }
  
  .subtitle {
    margin-top: 8px;
    margin-bottom: 25px;
    font-size: clamp(12px, 3vw, 14px);
    font-weight: 500;
    color: white;
    text-align: center;
  }
  
  .card {
    background: #1a1a1a;
    padding: clamp(20px, 5vw, 30px);
    border-radius: 12px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    border: 1px solid #2a2a2a;
  }
  
  .sensor-item {
    background: #242424;
    padding: clamp(16px, 4vw, 20px);
    border-radius: 8px;
    margin: 12px 0;
    border: 1px solid #333;
  }
  
  .sensor-item p {
    font-size: clamp(12px, 3vw, 14px);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #888;
  }
  
  .value {
    font-size: clamp(32px, 8vw, 42px);
    font-weight: 700;
    color: #ffffff;
    letter-spacing: -1px;
  }
  
  #historySection {
    margin-top: 30px;
    width: 100%;
    max-width: 380px;
  }
  
  #historySection h3 {
    margin: 0 0 15px 0;
    font-weight: 600;
    font-size: clamp(18px, 4vw, 20px);
    color: #ffffff;
  }
  
  .history-header {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
    padding: 10px 0;
    flex-wrap: wrap;
  }
  
  .history-header small {
    font-weight: 400;
    color: #888;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #clearHistoryBtn {
    margin-left: auto;
    background: #242424;
    color: #e0e0e0;
    border: 1px solid #333;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: clamp(11px, 2.5vw, 13px);
    transition: all 0.2s ease;
  }
  
  #clearHistoryBtn:hover {
    background: #2a2a2a;
    border-color: #444;
  }
  
  #clearHistoryBtn:active {
    transform: scale(0.95);
  }
  
  #history {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 350px;
    overflow: auto;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
  }
  
  #history::-webkit-scrollbar {
    width: 6px;
  }
  
  #history::-webkit-scrollbar-track {
    background: #0a0a0a;
  }
  
  #history::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 3px;
  }
  
  #history::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  #history li {
    padding: clamp(12px, 3vw, 14px) clamp(12px, 3vw, 16px);
    border-bottom: 1px solid #242424;
  }
  
  #history li:last-child {
    border-bottom: none;
  }
  
  #history li:hover {
    background: #242424;
  }
  
  .history-item-content {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .history-values {
    display: flex;
    gap: clamp(12px, 4vw, 20px);
    flex-wrap: wrap;
  }
  
  .history-value {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 600;
    color: #ffffff;
  }
  
  .history-time {
    font-size: clamp(11px, 2.5vw, 12px);
    text-align: right;
    color: #666;
    font-weight: 400;
    white-space: nowrap;
  }
  
  #historyEmpty, #historyHint, #errorMsg {
    display: block;
    margin-top: 10px;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #historyEmpty {
    color: #666;
  }
  
  #historyHint {
    color: #666;
  }
  
  #errorMsg {
    color: #ff6b6b;
    background: #2a1a1a;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    border: 1px solid #3a2020;
  }
  
  /* Light indicator */
  .light-indicator {
    width: clamp(48px, 12vw, 64px);
    height: clamp(48px, 12vw, 64px);
    border-radius: 50%;
    margin: 10px auto 0 auto;
    border: 2px solid #333;
    transition: box-shadow 0.25s ease, background 0.25s ease;
  }
  .light-state {
    display: block;
    margin-top: 8px;
    color: #aaa;
    font-size: clamp(11px, 2.5vw, 13px);
    font-weight: 500;
  }
  
  .light-low {
    background: radial-gradient(closest-side, #2a2a2a 0%, #1e1e1e 60%, #161616 100%);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
  }
  .light-medium {
    background: radial-gradient(closest-side, #555 0%, #2f2f2f 70%, #1a1a1a 100%);
    box-shadow: 0 0 8px rgba(255,255,255,0.15);
  }
  .light-high {
    background: radial-gradient(closest-side, #ffd24a 0%, #caa63a 70%, #1a1a1a 100%);
    box-shadow: 0 0 12px rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25);
    animation: pulseGlow 1.6s ease-out infinite;
  }
  
  @keyframes pulseGlow {
    0% { box-shadow: 0 0 0 0 rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25); }
    70% { box-shadow: 0 0 0 16px rgba(255,210,74,0), 0 0 10px rgba(255,210,74,0.2); }
    100% { box-shadow: 0 0 0 0 rgba(255,210,74,0), 0 0 24px rgba(255,210,74,0.25); }
  }
  
  /* Mobile-specific optimizations */
  @media (max-width: 480px) {
    body {
      padding: 20px 10px;
    }
    
    .card {
      border-radius: 10px;
    }
    
    .sensor-item {
      margin: 10px 0;
    }
    
    #history {
      max-height: 300px;
    }
    
    .history-item-content {
      gap: 10px;
    }
  }
  
  /* Improved touch targets for mobile */
  @media (hover: none) {
    #clearHistoryBtn {
      min-height: 44px;
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
  
  /* Thresholds and advice UI */
  .form {
    margin-top: 10px;
  }
  .form-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin: 8px 0;
  }
  .form-row label {
    color: #bbb;
    font-size: clamp(12px, 3vw, 13px);
  }
  .form-row input[type="number"] {
    width: 100px;
    background: #0f0f0f;
    color: #e0e0e0;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 8px 10px;
  }
  .advice-list {
    list-style: none;
    padding: 0;
    margin: 8px 0 0 0;
    text-align: left;
  }
  .advice-list li {
    background: #242424;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px 12px;
    margin: 8px 0;
    font-size: clamp(12px, 3vw, 14px);
  }
  .advice-empty {
    color: #666;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 12px;
    margin-left: 8px;
    border: 1px solid transparent;
  }
  .badge-ok { background: #143a1a; color: #9be29f; border-color: #1e5226; }
  .badge-warn { background: #3a2f14; color: #f2d28c; border-color: #5a4a1e; }
  .badge-alert { background: #3a1414; color: #ff9e9e; border-color: #5a1e1e; }
</style>
</head>
<body>

<h2>üß† Smart Room Monitor</h2>

<div class="subtitle">Himavarshith Reddy, RA2211026010170</div>

<div class="card">
  <div class="sensor-item">
    <p>Temperature</p>
    <div id="temp" class="value">-- ¬∞C</div>
  </div>
  
  <div class="sensor-item">
    <p>Humidity</p>
    <div id="hum" class="value">-- %</div>
  </div>
  
  <div class="sensor-item">
    <p>Light</p>
    <div id="light" class="value">-- %</div>
    <div id="lightIndicator" class="light-indicator light-low" aria-label="Light indicator"></div>
    <small id="lightState" class="light-state">‚Äî</small>
  </div>
</div>

<div class="card" id="thresholdsCard">
  <h3>‚öôÔ∏è Thresholds</h3>
  <div class="form">
    <div class="form-row">
      <label for="tempMin">Temperature min (¬∞C)</label>
      <input id="tempMin" type="number" step="0.5" />
    </div>
    <div class="form-row">
      <label for="tempMax">Temperature max (¬∞C)</label>
      <input id="tempMax" type="number" step="0.5" />
    </div>
    <div class="form-row">
      <label for="humMin">Humidity min (%)</label>
      <input id="humMin" type="number" step="1" />
    </div>
    <div class="form-row">
      <label for="humMax">Humidity max (%)</label>
      <input id="humMax" type="number" step="1" />
    </div>
    <div class="form-row">
      <label for="lightLow">Light low (%)</label>
      <input id="lightLow" type="number" step="1" />
    </div>
    <div class="form-row">
      <label for="lightHigh">Light high (%)</label>
      <input id="lightHigh" type="number" step="1" />
    </div>
  </div>
  <small id="thresholdsHint" class="subtitle" style="margin:10px 0 0 0;">Saved locally ‚Ä¢ updates suggestions live</small>
  
</div>

<div class="card" id="adviceCard">
  <h3>üß≠ Suggestions</h3>
  <div>
    <p class="subtitle" style="margin:6px 0 8px 0;">Per aspect</p>
    <ul id="perAdviceList" class="advice-list"></ul>
    <small id="perAdviceEmpty" class="advice-empty">All values within thresholds.</small>
  </div>
  <div style="margin-top:14px;">
    <p class="subtitle" style="margin:6px 0 8px 0;">Combined</p>
    <ul id="combinedAdviceList" class="advice-list"></ul>
    <small id="combinedAdviceEmpty" class="advice-empty">No combined actions needed.</small>
  </div>
</div>

<div id="historySection">
  <h3>üìä History</h3>
  <div class="history-header">
    <small>Last 50 readings</small>
    <button id="clearHistoryBtn">Clear</button>
  </div>
  <ul id="history">
    <!-- history items injected here -->
  </ul>
  <small id="historyEmpty" style="display:none;">No history yet.</small>
  <small id="historyHint">New entries are saved automatically.</small>
  <small id="errorMsg" style="display:none;">Could not fetch data. Retrying‚Ä¶</small>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// ---- Thresholds (with persistence) ----
const THRESHOLDS_KEY = 'sensorThresholds';
const DEFAULT_THRESHOLDS = {
  temperature: { min: 20, max: 26 },
  humidity: { min: 40, max: 60 },
  light: { low: 20, high: 70 }
};

function loadThresholdsStore() {
  try {
    const raw = JSON.parse(localStorage.getItem(THRESHOLDS_KEY) || 'null');
    if (!raw || typeof raw !== 'object') return structuredClone(DEFAULT_THRESHOLDS);
    return {
      temperature: { ...DEFAULT_THRESHOLDS.temperature, ...(raw.temperature || {}) },
      humidity: { ...DEFAULT_THRESHOLDS.humidity, ...(raw.humidity || {}) },
      light: { ...DEFAULT_THRESHOLDS.light, ...(raw.light || {}) }
    };
  } catch { return structuredClone(DEFAULT_THRESHOLDS); }
}

function saveThresholdsStore(t) {
  try { localStorage.setItem(THRESHOLDS_KEY, JSON.stringify(t)); } catch {}
}

let thresholds = loadThresholdsStore();

// ---- Persistent history helpers ----
const HISTORY_KEY = 'sensorHistory';
const MAX_HISTORY = 50;

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  } catch { return []; }
}

function saveHistory(list) {
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); } catch {}
}

function formatTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString();
  } catch { return iso; }
}

function renderHistory(list) {
  const ul = document.getElementById('history');
  const empty = document.getElementById('historyEmpty');
  ul.innerHTML = '';
  if (!list || list.length === 0) {
    empty.style.display = 'inline';
    return;
  }
  empty.style.display = 'none';
  list.forEach(item => {
    const li = document.createElement('li');
    const lightHtml = (item.light === undefined || item.light === null) ? '' : `
        <div class="history-value">üí° ${item.light}%</div>
      `;
    li.innerHTML = `<div class=\"history-item-content\">\n      <div class=\"history-values\">\n        <div class=\"history-value\">üå°Ô∏è ${item.temperature}¬∞C</div>\n        <div class=\"history-value\">üíß ${item.humidity}%</div>\n        ${lightHtml}\n      </div>\n      <div class=\"history-time\">${formatTime(item.time)}</div>\n    </div>`;
    ul.appendChild(li);
  });
}

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
  saveHistory([]);
  renderHistory([]);
});

// Initialize history on load
let historyList = loadHistory();
renderHistory(historyList);
let lastRecorded = historyList.length ? { t: historyList[0].temperature, h: historyList[0].humidity, l: historyList[0].light } : null; // newest-first

// Light thresholds for 0‚Äì100 scale
const LIGHT_THRESHOLDS = { low: thresholds.light.low, high: thresholds.light.high };

function updateLightUI(lightValue) {
  const indicator = document.getElementById('lightIndicator');
  const stateEl = document.getElementById('lightState');
  if (!indicator || !stateEl) return;
  const numeric = Number(lightValue);
  indicator.classList.remove('light-low', 'light-medium', 'light-high');
  indicator.style.boxShadow = '';
  indicator.style.background = '';
  let stateLabel = 'Moderate';
  if (Number.isFinite(numeric)) {
    if (numeric >= LIGHT_THRESHOLDS.high) {
      indicator.classList.add('light-high');
      stateLabel = 'Bright';
    } else if (numeric <= LIGHT_THRESHOLDS.low) {
      indicator.classList.add('light-low');
      stateLabel = 'Dark';
    } else {
      indicator.classList.add('light-medium');
      stateLabel = 'Moderate';
      const span = LIGHT_THRESHOLDS.high - LIGHT_THRESHOLDS.low;
      const frac = span > 0 ? Math.min(1, Math.max(0, (numeric - LIGHT_THRESHOLDS.low) / span)) : 0;
      const glowAlpha = 0.25 + 0.50 * frac;
      const centerAlpha = 0.45 + 0.50 * frac;
      const glowBlur = 10 + 20 * frac;
      const outerBlur = Math.round(glowBlur * 1.6);
      indicator.style.boxShadow = `0 0 ${glowBlur}px rgba(255, 215, 128, ${glowAlpha}), 0 0 ${outerBlur}px rgba(255, 215, 128, ${glowAlpha * 0.6})`;
      indicator.style.background = `radial-gradient(closest-side, rgba(255, 215, 128, ${centerAlpha}) 0%, #3a3a3a 65%, #1a1a1a 100%)`;
    }
  } else {
    indicator.classList.add('light-low');
    stateLabel = '‚Äî';
  }
  stateEl.textContent = stateLabel;
}

// ---- Advice generation ----
function renderPerAdvice(items) {
  const ul = document.getElementById('perAdviceList');
  const empty = document.getElementById('perAdviceEmpty');
  if (!ul || !empty) return;
  ul.innerHTML = '';
  if (!items.length) { empty.style.display = 'inline'; return; }
  empty.style.display = 'none';
  items.forEach(html => {
    const li = document.createElement('li');
    li.innerHTML = html;
    ul.appendChild(li);
  });
}

function renderCombinedAdvice(items) {
  const ul = document.getElementById('combinedAdviceList');
  const empty = document.getElementById('combinedAdviceEmpty');
  if (!ul || !empty) return;
  ul.innerHTML = '';
  if (!items.length) { empty.style.display = 'inline'; return; }
  empty.style.display = 'none';
  items.forEach(html => {
    const li = document.createElement('li');
    li.innerHTML = html;
    ul.appendChild(li);
  });
}

function badge(text, kind) {
  const klass = kind === 'ok' ? 'badge-ok' : kind === 'alert' ? 'badge-alert' : 'badge-warn';
  return `<span class="badge ${klass}">${text}</span>`;
}

function evaluatePerAspectAdvice(currentVals, th) {
  const adv = [];
  if (Number.isFinite(currentVals.temperature)) {
    if (currentVals.temperature > th.temperature.max) {
      adv.push(`It is hot (\u2265 ${th.temperature.max}¬∞C). Turn on AC/fan ${badge('Action', 'alert')}`);
    } else if (currentVals.temperature < th.temperature.min) {
      adv.push(`It is cold (\u2264 ${th.temperature.min}¬∞C). Turn on heater ${badge('Action', 'alert')}`);
    } else {
      adv.push(`Temperature is comfortable ${badge('OK', 'ok')}`);
    }
  }
  if (Number.isFinite(currentVals.humidity)) {
    if (currentVals.humidity > th.humidity.max) {
      adv.push(`Humidity is high (\u2265 ${th.humidity.max}%). Use dehumidifier/ventilation ${badge('Action', 'warn')}`);
    } else if (currentVals.humidity < th.humidity.min) {
      adv.push(`Air is dry (\u2264 ${th.humidity.min}%). Use humidifier ${badge('Action', 'warn')}`);
    } else {
      adv.push(`Humidity is optimal ${badge('OK', 'ok')}`);
    }
  }
  if (Number.isFinite(currentVals.light)) {
    if (currentVals.light >= th.light.high) {
      adv.push(`Light is bright (\u2265 ${th.light.high}%). Dim lights/close curtains ${badge('Action', 'warn')}`);
    } else if (currentVals.light <= th.light.low) {
      adv.push(`Room is dark (\u2264 ${th.light.low}%). Turn on lights/open curtains ${badge('Action', 'warn')}`);
    } else {
      adv.push(`Light level is moderate ${badge('OK', 'ok')}`);
    }
  }
  return adv;
}

function evaluateCombinedAdvice(currentVals, th) {
  const actions = [];
  const hot = Number.isFinite(currentVals.temperature) && currentVals.temperature > th.temperature.max;
  const cold = Number.isFinite(currentVals.temperature) && currentVals.temperature < th.temperature.min;
  const humid = Number.isFinite(currentVals.humidity) && currentVals.humidity > th.humidity.max;
  const dry = Number.isFinite(currentVals.humidity) && currentVals.humidity < th.humidity.min;
  const bright = Number.isFinite(currentVals.light) && currentVals.light >= th.light.high;
  const dark = Number.isFinite(currentVals.light) && currentVals.light <= th.light.low;

  if (hot && humid) actions.push(`Turn on AC and dehumidifier; ventilate if possible ${badge('Strong', 'alert')}`);
  if (hot && dry) actions.push(`Run AC and a humidifier to add moisture ${badge('Action', 'warn')}`);
  if (cold && dry) actions.push(`Turn on heater and humidifier ${badge('Action', 'warn')}`);
  if (cold && humid) actions.push(`Turn on heater and dehumidify; ensure airflow ${badge('Strong', 'alert')}`);
  if (bright && hot) actions.push(`Close curtains/blinds to reduce heat gain, run AC ${badge('Action', 'warn')}`);
  if (dark && !hot && !cold) actions.push(`Only lighting adjustment needed: turn on lights/open curtains ${badge('Info', 'ok')}`);
  if (!actions.length && (hot || cold || humid || dry || bright || dark)) {
    actions.push(`Minor adjustments recommended based on individual aspects ${badge('Info', 'ok')}`);
  }
  return actions;
}

function updateAdvice() {
  const per = evaluatePerAspectAdvice(current, thresholds);
  const combined = evaluateCombinedAdvice(current, thresholds);
  renderPerAdvice(per);
  renderCombinedAdvice(combined);
}

function initializeThresholdUI() {
  const tempMin = document.getElementById('tempMin');
  const tempMax = document.getElementById('tempMax');
  const humMin = document.getElementById('humMin');
  const humMax = document.getElementById('humMax');
  const lightLow = document.getElementById('lightLow');
  const lightHigh = document.getElementById('lightHigh');
  if (!tempMin || !tempMax || !humMin || !humMax || !lightLow || !lightHigh) return;

  tempMin.value = String(thresholds.temperature.min);
  tempMax.value = String(thresholds.temperature.max);
  humMin.value = String(thresholds.humidity.min);
  humMax.value = String(thresholds.humidity.max);
  lightLow.value = String(thresholds.light.low);
  lightHigh.value = String(thresholds.light.high);

  function numOrFallback(v, fb) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fb;
  }

  function onChange() {
    const tmin = numOrFallback(tempMin.value, thresholds.temperature.min);
    const tmax = numOrFallback(tempMax.value, thresholds.temperature.max);
    const hmin = numOrFallback(humMin.value, thresholds.humidity.min);
    const hmax = numOrFallback(humMax.value, thresholds.humidity.max);
    const llow = Math.max(0, Math.min(100, numOrFallback(lightLow.value, thresholds.light.low)));
    const lhigh = Math.max(0, Math.min(100, numOrFallback(lightHigh.value, thresholds.light.high)));

    thresholds = {
      temperature: { min: Math.min(tmin, tmax), max: Math.max(tmin, tmax) },
      humidity: { min: Math.min(hmin, hmax), max: Math.max(hmin, hmax) },
      light: { low: Math.min(llow, lhigh), high: Math.max(llow, lhigh) }
    };
    LIGHT_THRESHOLDS.low = thresholds.light.low;
    LIGHT_THRESHOLDS.high = thresholds.light.high;
    saveThresholdsStore(thresholds);
    if (Number.isFinite(current.light)) updateLightUI(current.light);
    updateAdvice();
  }

  [tempMin, tempMax, humMin, humMax, lightLow, lightHigh].forEach(el => {
    el.addEventListener('input', onChange);
    el.addEventListener('change', onChange);
  });
}

// ---- MQTT (HiveMQ Cloud over WebSockets) ----
const MQTT_URL = 'wss://c047bd013b954dfd8ac40154210890bf.s1.eu.hivemq.cloud:8884/mqtt';
const MQTT_OPTIONS = {
  username: 'espuser',
  password: 'Esp12345',
  keepalive: 30,
  clean: true,
  reconnectPeriod: 1500,
  connectTimeout: 8000,
  protocolVersion: 4
};

const TOPICS = ['iot/data/temperature', 'iot/data/humidity', 'iot/data/light'];

const err = document.getElementById('errorMsg');
if (err) { err.textContent = 'Connecting to MQTT‚Ä¶'; err.style.display = 'inline'; }

// Seed UI from last saved history, if available
if (historyList.length) {
  const last = historyList[0];
  if (last.temperature !== undefined) document.getElementById('temp').textContent = last.temperature + ' ¬∞C';
  if (last.humidity !== undefined) document.getElementById('hum').textContent = last.humidity + ' %';
  if (last.light !== undefined) {
    document.getElementById('light').textContent = last.light + ' %';
    updateLightUI(last.light);
  }
}

// Initialize thresholds UI and initial advice
initializeThresholdUI();
updateAdvice();

let current = {
  temperature: historyList[0]?.temperature,
  humidity: historyList[0]?.humidity,
  light: historyList[0]?.light
};

let client;
try {
  client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
} catch (e) {
  if (err) { err.textContent = 'Failed to init MQTT client.'; err.style.display = 'inline'; }
}

if (client) {
  client.on('connect', () => {
    if (err) err.style.display = 'none';
    client.subscribe(TOPICS, (subErr) => {
      if (subErr && err) {
        err.textContent = 'MQTT subscribe failed. Retrying‚Ä¶';
        err.style.display = 'inline';
      }
    });
  });

  client.on('reconnect', () => {
    if (err) { err.textContent = 'MQTT reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('offline', () => {
    if (err) { err.textContent = 'MQTT offline. Reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('error', () => {
    if (err) { err.textContent = 'MQTT error. Retrying‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('message', (topic, payload) => {
    const text = payload ? payload.toString() : '';
    const num = Number(text);
    if (!Number.isFinite(num)) return;

    if (topic === 'iot/data/temperature') {
      const v = Number(num.toFixed(1));
      document.getElementById('temp').textContent = v + ' ¬∞C';
      current.temperature = v;
    } else if (topic === 'iot/data/humidity') {
      const v = Number(num.toFixed(1));
      document.getElementById('hum').textContent = v + ' %';
      current.humidity = v;
    } else if (topic === 'iot/data/light') {
      const v = Math.round(num);
      document.getElementById('light').textContent = v + ' %';
      updateLightUI(v);
      current.light = v;
    }

    const changed = !lastRecorded || current.temperature !== lastRecorded.t || current.humidity !== lastRecorded.h || current.light !== lastRecorded.l;
    if (changed && current.temperature != null && current.humidity != null) {
      const entry = {
        time: new Date().toISOString(),
        temperature: current.temperature,
        humidity: current.humidity,
        light: current.light
      };
      historyList = [entry, ...historyList].slice(0, MAX_HISTORY);
      saveHistory(historyList);
      renderHistory(historyList);
      lastRecorded = { t: current.temperature, h: current.humidity, l: current.light };
    }
    // Update advice on every value change
    updateAdvice();
  });
}
</script>

</body>
</html>