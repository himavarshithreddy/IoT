<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Live IoT Data</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: #0a0a0a;
    min-height: 100vh;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 15px;
  }
  
  h2 {
    font-size: clamp(22px, 5vw, 28px);
    font-weight: 600;
    margin-bottom: 8px;
    color: #ffffff;
    text-align: center;
  }
  
  .subtitle {
    margin-top: 8px;
    margin-bottom: 25px;
    font-size: clamp(12px, 3vw, 14px);
    font-weight: 400;
    color: #888;
    text-align: center;
  }
  
  .card {
    background: #1a1a1a;
    padding: clamp(20px, 5vw, 30px);
    border-radius: 12px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    border: 1px solid #2a2a2a;
  }
  
  .sensor-item {
    background: #242424;
    padding: clamp(16px, 4vw, 20px);
    border-radius: 8px;
    margin: 12px 0;
    border: 1px solid #333;
  }
  
  .sensor-item p {
    font-size: clamp(12px, 3vw, 14px);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #888;
  }
  
  .value {
    font-size: clamp(32px, 8vw, 42px);
    font-weight: 700;
    color: #ffffff;
    letter-spacing: -1px;
  }
  
  #historySection {
    margin-top: 30px;
    width: 100%;
    max-width: 380px;
  }
  
  #historySection h3 {
    margin: 0 0 15px 0;
    font-weight: 600;
    font-size: clamp(18px, 4vw, 20px);
    color: #ffffff;
  }
  
  .history-header {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
    padding: 10px 0;
    flex-wrap: wrap;
  }
  
  .history-header small {
    font-weight: 400;
    color: #888;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #clearHistoryBtn {
    margin-left: auto;
    background: #242424;
    color: #e0e0e0;
    border: 1px solid #333;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: clamp(11px, 2.5vw, 13px);
    transition: all 0.2s ease;
  }
  
  #clearHistoryBtn:hover {
    background: #2a2a2a;
    border-color: #444;
  }
  
  #clearHistoryBtn:active {
    transform: scale(0.95);
  }
  
  #history {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 350px;
    overflow: auto;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
  }
  
  #history::-webkit-scrollbar {
    width: 6px;
  }
  
  #history::-webkit-scrollbar-track {
    background: #0a0a0a;
  }
  
  #history::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 3px;
  }
  
  #history::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  #history li {
    padding: clamp(12px, 3vw, 14px) clamp(12px, 3vw, 16px);
    border-bottom: 1px solid #242424;
  }
  
  #history li:last-child {
    border-bottom: none;
  }
  
  #history li:hover {
    background: #242424;
  }
  
  .history-item-content {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .history-values {
    display: flex;
    gap: clamp(12px, 4vw, 20px);
    flex-wrap: wrap;
  }
  
  .history-value {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 600;
    color: #ffffff;
  }
  
  .history-time {
    font-size: clamp(11px, 2.5vw, 12px);
    text-align: right;
    color: #666;
    font-weight: 400;
    white-space: nowrap;
  }
  
  #historyEmpty, #historyHint, #errorMsg {
    display: block;
    margin-top: 10px;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #historyEmpty {
    color: #666;
  }
  
  #historyHint {
    color: #666;
  }
  
  #errorMsg {
    color: #ff6b6b;
    background: #2a1a1a;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    border: 1px solid #3a2020;
  }
  
  /* Light indicator */
  .light-indicator {
    width: clamp(48px, 12vw, 64px);
    height: clamp(48px, 12vw, 64px);
    border-radius: 50%;
    margin: 10px auto 0 auto;
    border: 2px solid #333;
    transition: box-shadow 0.25s ease, background 0.25s ease;
  }
  .light-state {
    display: block;
    margin-top: 8px;
    color: #aaa;
    font-size: clamp(11px, 2.5vw, 13px);
    font-weight: 500;
  }
  
  .light-low {
    background: radial-gradient(closest-side, #2a2a2a 0%, #1e1e1e 60%, #161616 100%);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
  }
  .light-medium {
    background: radial-gradient(closest-side, #555 0%, #2f2f2f 70%, #1a1a1a 100%);
    box-shadow: 0 0 8px rgba(255,255,255,0.15);
  }
  .light-high {
    background: radial-gradient(closest-side, #ffd24a 0%, #caa63a 70%, #1a1a1a 100%);
    box-shadow: 0 0 12px rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25);
    animation: pulseGlow 1.6s ease-out infinite;
  }
  
  @keyframes pulseGlow {
    0% { box-shadow: 0 0 0 0 rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25); }
    70% { box-shadow: 0 0 0 16px rgba(255,210,74,0), 0 0 10px rgba(255,210,74,0.2); }
    100% { box-shadow: 0 0 0 0 rgba(255,210,74,0), 0 0 24px rgba(255,210,74,0.25); }
  }
  
  /* Mobile-specific optimizations */
  @media (max-width: 480px) {
    body {
      padding: 20px 10px;
    }
    
    .card {
      border-radius: 10px;
    }
    
    .sensor-item {
      margin: 10px 0;
    }
    
    #history {
      max-height: 300px;
    }
    
    .history-item-content {
      gap: 10px;
    }
  }
  
  /* Improved touch targets for mobile */
  @media (hover: none) {
    #clearHistoryBtn {
      min-height: 44px;
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
</style>
</head>
<body>

<h2>üå°Ô∏è Live ESP32 Sensor Data</h2>

<div class="subtitle">Himavarshith Reddy, RA2211026010170</div>

<div class="card">
  <div class="sensor-item">
    <p>Temperature</p>
    <div id="temp" class="value">-- ¬∞C</div>
  </div>
  
  <div class="sensor-item">
    <p>Humidity</p>
    <div id="hum" class="value">-- %</div>
  </div>
  
  <div class="sensor-item">
    <p>Light</p>
    <div id="light" class="value">-- %</div>
    <div id="lightIndicator" class="light-indicator light-low" aria-label="Light indicator"></div>
    <small id="lightState" class="light-state">‚Äî</small>
  </div>
</div>

<div id="historySection">
  <h3>üìä History</h3>
  <div class="history-header">
    <small>Last 50 readings</small>
    <button id="clearHistoryBtn">Clear</button>
  </div>
  <ul id="history">
    <!-- history items injected here -->
  </ul>
  <small id="historyEmpty" style="display:none;">No history yet.</small>
  <small id="historyHint">New entries are saved automatically.</small>
  <small id="errorMsg" style="display:none;">Could not fetch data. Retrying‚Ä¶</small>
</div>

<script>
const url = "https://690a61b31a446bb9cc226e5f.mockapi.io/api/sensor";

// ---- Persistent history helpers ----
const HISTORY_KEY = 'sensorHistory';
const MAX_HISTORY = 50;

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  } catch { return []; }
}

function saveHistory(list) {
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); } catch {}
}

function formatTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString();
  } catch { return iso; }
}

function renderHistory(list) {
  const ul = document.getElementById('history');
  const empty = document.getElementById('historyEmpty');
  ul.innerHTML = '';
  if (!list || list.length === 0) {
    empty.style.display = 'inline';
    return;
  }
  empty.style.display = 'none';
  list.forEach(item => {
    const li = document.createElement('li');
    const lightHtml = (item.light === undefined || item.light === null) ? '' : `
        <div class="history-value">üí° ${item.light}%</div>
      `;
    li.innerHTML = `<div class="history-item-content">
      <div class="history-values">
        <div class="history-value">üå°Ô∏è ${item.temperature}¬∞C</div>
        <div class="history-value">üíß ${item.humidity}%</div>
        ${lightHtml}
      </div>
      <div class="history-time">${formatTime(item.time)}</div>
    </div>`;
    ul.appendChild(li);
  });
}

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
  saveHistory([]);
  renderHistory([]);
});

// Initialize history on load
let historyList = loadHistory();
renderHistory(historyList);
let lastRecorded = historyList.length ? { t: historyList[0].temperature, h: historyList[0].humidity, l: historyList[0].light } : null; // we render newest-first later

// Light thresholds for 0‚Äì100 scale
const LIGHT_THRESHOLDS = { low: 20, high: 70 };

function updateLightUI(lightValue) {
  const indicator = document.getElementById('lightIndicator');
  const stateEl = document.getElementById('lightState');
  if (!indicator || !stateEl) return;
  indicator.classList.remove('light-low', 'light-medium', 'light-high');
  let stateLabel = 'Moderate';
  if (typeof lightValue === 'number') {
    if (lightValue >= LIGHT_THRESHOLDS.high) {
      indicator.classList.add('light-high');
      stateLabel = 'Bright';
    } else if (lightValue <= LIGHT_THRESHOLDS.low) {
      indicator.classList.add('light-low');
      stateLabel = 'Dark';
    } else {
      indicator.classList.add('light-medium');
      stateLabel = 'Moderate';
    }
  } else {
    indicator.classList.add('light-low');
    stateLabel = '‚Äî';
  }
  stateEl.textContent = stateLabel;
}

async function fetchData() {
  const err = document.getElementById('errorMsg');
  try {
    let res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    let data = await res.json();
    if (err) err.style.display = 'none';

    let last = data[data.length - 1];
    if (!last) return;
    document.getElementById("temp").textContent = last.temperature + " ¬∞C";
    document.getElementById("hum").textContent  = last.humidity + " %";
    if (last.light !== undefined) {
      document.getElementById("light").textContent = last.light + " %";
      updateLightUI(last.light);
    }

    // Append to history only if values changed to avoid flooding
    const changed = !lastRecorded || last.temperature !== lastRecorded.t || last.humidity !== lastRecorded.h || last.light !== lastRecorded.l;
    if (changed) {
      const entry = {
        time: new Date().toISOString(),
        temperature: last.temperature,
        humidity: last.humidity,
        light: last.light
      };
      // newest first
      historyList = [entry, ...historyList].slice(0, MAX_HISTORY);
      saveHistory(historyList);
      renderHistory(historyList);
      lastRecorded = { t: last.temperature, h: last.humidity, l: last.light };
    }
  } catch (e) {
    if (err) err.style.display = 'inline';
  }
}

setInterval(fetchData, 1500);
fetchData();
</script>

</body>
</html>
