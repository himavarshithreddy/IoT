<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Live IoT Data</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: #0a0a0a;
    min-height: 100vh;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 15px;
  }
  
  h2 {
    font-size: clamp(22px, 5vw, 28px);
    font-weight: 600;
    margin-bottom: 8px;
    color: #ffffff;
    text-align: center;
  }
  
  .subtitle {
    margin-top: 8px;
    margin-bottom: 25px;
    font-size: clamp(12px, 3vw, 14px);
    font-weight: 500;
    color: white;
    text-align: center;
  }
  
  .card {
    background: #1a1a1a;
    padding: clamp(20px, 5vw, 30px);
    border-radius: 12px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    border: 1px solid #2a2a2a;
  }
  
  .sensor-item {
    background: #242424;
    padding: clamp(16px, 4vw, 20px);
    border-radius: 8px;
    margin: 12px 0;
    border: 1px solid #333;
  }
  
  .sensor-item p {
    font-size: clamp(12px, 3vw, 14px);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #888;
  }
  
  .value {
    font-size: clamp(32px, 8vw, 42px);
    font-weight: 700;
    color: #ffffff;
    letter-spacing: -1px;
  }
  
  #historySection {
    margin-top: 30px;
    width: 100%;
    max-width: 380px;
  }
  
  #historySection h3 {
    margin: 0 0 15px 0;
    font-weight: 600;
    font-size: clamp(18px, 4vw, 20px);
    color: #ffffff;
  }
  
  .history-header {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
    padding: 10px 0;
    flex-wrap: wrap;
  }
  
  .history-header small {
    font-weight: 400;
    color: #888;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #clearHistoryBtn {
    margin-left: auto;
    background: #242424;
    color: #e0e0e0;
    border: 1px solid #333;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: clamp(11px, 2.5vw, 13px);
    transition: all 0.2s ease;
  }
  
  #clearHistoryBtn:hover {
    background: #2a2a2a;
    border-color: #444;
  }
  
  #clearHistoryBtn:active {
    transform: scale(0.95);
  }
  
  #history {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 350px;
    overflow: auto;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
  }
  
  #history::-webkit-scrollbar {
    width: 6px;
  }
  
  #history::-webkit-scrollbar-track {
    background: #0a0a0a;
  }
  
  #history::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 3px;
  }
  
  #history::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  #history li {
    padding: clamp(12px, 3vw, 14px) clamp(12px, 3vw, 16px);
    border-bottom: 1px solid #242424;
  }
  
  #history li:last-child {
    border-bottom: none;
  }
  
  #history li:hover {
    background: #242424;
  }
  
  .history-item-content {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .history-values {
    display: flex;
    gap: clamp(12px, 4vw, 20px);
    flex-wrap: wrap;
  }
  
  .history-value {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 600;
    color: #ffffff;
  }
  
  .history-time {
    font-size: clamp(11px, 2.5vw, 12px);
    text-align: right;
    color: #666;
    font-weight: 400;
    white-space: nowrap;
  }
  
  #historyEmpty, #historyHint, #errorMsg {
    display: block;
    margin-top: 10px;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  
  #historyEmpty {
    color: #666;
  }
  
  #historyHint {
    color: #666;
  }
  
  #errorMsg {
    color: #ff6b6b;
    background: #2a1a1a;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    border: 1px solid #3a2020;
  }
  
  /* Light indicator */
  .light-indicator {
    width: clamp(48px, 12vw, 64px);
    height: clamp(48px, 12vw, 64px);
    border-radius: 50%;
    margin: 10px auto 0 auto;
    border: 2px solid #333;
    transition: box-shadow 0.25s ease, background 0.25s ease;
  }
  .light-state {
    display: block;
    margin-top: 8px;
    color: #aaa;
    font-size: clamp(11px, 2.5vw, 13px);
    font-weight: 500;
  }
  
  .light-low {
    background: radial-gradient(closest-side, #2a2a2a 0%, #1e1e1e 60%, #161616 100%);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
  }
  .light-medium {
    background: radial-gradient(closest-side, #555 0%, #2f2f2f 70%, #1a1a1a 100%);
    box-shadow: 0 0 8px rgba(255,255,255,0.15);
  }
  .light-high {
    background: radial-gradient(closest-side, #ffd24a 0%, #caa63a 70%, #1a1a1a 100%);
    box-shadow: 0 0 12px rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25);
    animation: pulseGlow 1.6s ease-out infinite;
  }
  
  @keyframes pulseGlow {
    0% { box-shadow: 0 0 0 0 rgba(255,210,74,0.45), 0 0 24px rgba(255,210,74,0.25); }
    70% { box-shadow: 0 0 0 16px rgba(255,210,74,0), 0 0 10px rgba(255,210,74,0.2); }
    100% { box-shadow: 0 0 0 0 rgba(255,210,74,0), 0 0 24px rgba(255,210,74,0.25); }
  }
  
  /* Mobile-specific optimizations */
  @media (max-width: 480px) {
    body {
      padding: 20px 10px;
    }
    
    .card {
      border-radius: 10px;
    }
    
    .sensor-item {
      margin: 10px 0;
    }
    
    #history {
      max-height: 300px;
    }
    
    .history-item-content {
      gap: 10px;
    }
  }
  
  /* Improved touch targets for mobile */
  @media (hover: none) {
    #clearHistoryBtn {
      min-height: 44px;
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
  
  /* Smart actions UI */
  .smart-section {
    margin-top: 24px;
    width: 100%;
    max-width: 380px;
  }
  .smart-section h3 {
    margin: 0 0 12px 0;
    font-weight: 600;
    font-size: clamp(18px, 4vw, 20px);
    color: #ffffff;
  }
  .action-group {
    background: #242424;
    padding: 12px 14px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #333;
  }
  .action-group h4 {
    margin: 0 0 8px 0;
    font-size: clamp(11px, 2.5vw, 12px);
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .action-item {
    font-size: clamp(12px, 3vw, 14px);
    color: #e0e0e0;
    line-height: 1.4;
  }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    margin-right: 6px;
    background: #333;
    color: #ddd;
  }
  .severity-warn .badge { background: #3a2a1a; color: #f1c27d; }
  .severity-alert .badge { background: #3a2020; color: #ff9b9b; }
  .ok { color: #8bc34a; }

  /* Charts section */
  .charts-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chart-card {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 12px;
  }
  .chart-title {
    font-size: clamp(12px, 3vw, 13px);
    color: #aaa;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  canvas {
    width: 100% !important;
    height: 180px !important;
  }
</style>
</head>
<body>

<h2>üå°Ô∏è Live ESP32 Sensor Data</h2>

<div class="subtitle">Himavarshith Reddy, RA2211026010170</div>

<div class="card">
  <div class="sensor-item">
    <p>Temperature</p>
    <div id="temp" class="value">-- ¬∞C</div>
  </div>
  
  <div class="sensor-item">
    <p>Humidity</p>
    <div id="hum" class="value">-- %</div>
  </div>
  
  <div class="sensor-item">
    <p>Light</p>
    <div id="light" class="value">-- %</div>
    <div id="lightIndicator" class="light-indicator light-low" aria-label="Light indicator"></div>
    <small id="lightState" class="light-state">‚Äî</small>
  </div>
</div>

<div id="smartSection" class="smart-section">
  <h3>üß† Smart Room Monitor</h3>
  <div class="action-group" id="summaryGroup">
    <h4>Summary</h4>
    <div id="smartSummary" class="actions">
      <div class="action-item ok">Waiting for live data‚Ä¶</div>
    </div>
  </div>
  <div class="action-group">
    <h4>Temperature</h4>
    <div id="tempActions" class="actions"><div class="action-item ok">No action needed</div></div>
  </div>
  <div class="action-group">
    <h4>Humidity</h4>
    <div id="humActions" class="actions"><div class="action-item ok">No action needed</div></div>
  </div>
  <div class="action-group">
    <h4>Light</h4>
    <div id="lightActions" class="actions"><div class="action-item ok">No action needed</div></div>
  </div>
  <div class="action-group">
    <h4>Combined</h4>
    <div id="combinedActions" class="actions"><div class="action-item ok">No combined actions</div></div>
  </div>
</div>

<div id="historySection">
  <h3>üìà Graphs</h3>
  <div class="history-header">
    <small>Last 50 readings</small>
    <button id="clearHistoryBtn">Clear</button>
  </div>
  <div class="charts-grid" id="chartsGrid">
    <div class="chart-card">
      <div class="chart-title">Temperature (¬∞C)</div>
      <canvas id="chartTemp" aria-label="Temperature chart"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Humidity (%)</div>
      <canvas id="chartHum" aria-label="Humidity chart"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Light (%)</div>
      <canvas id="chartLight" aria-label="Light chart"></canvas>
    </div>
  </div>
  <small id="historyEmpty" style="display:none;">No data yet.</small>
  <small id="historyHint">New entries are saved automatically.</small>
  <small id="errorMsg" style="display:none;">Could not fetch data. Retrying‚Ä¶</small>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// ---- Persistent history helpers ----
const HISTORY_KEY = 'sensorHistory';
const MAX_HISTORY = 50;

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  } catch { return []; }
}

function saveHistory(list) {
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); } catch {}
}

function formatTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString();
  } catch { return iso; }
}

let tempChart, humChart, lightChart;

function createOrUpdateChart(chartRef, canvasId, label, labels, data, color) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return chartRef;
  if (!chartRef) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label,
          data,
          borderColor: color,
          backgroundColor: color + '33',
          tension: 0.25,
          fill: true,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: '#aaa', maxRotation: 0, autoSkip: true },
            grid: { color: 'rgba(255,255,255,0.06)' }
          },
          y: {
            ticks: { color: '#aaa' },
            grid: { color: 'rgba(255,255,255,0.06)' }
          }
        }
      }
    });
  } else {
    chartRef.data.labels = labels;
    chartRef.data.datasets[0].data = data;
    chartRef.update('none');
    return chartRef;
  }
}

function renderHistory(list) {
  const empty = document.getElementById('historyEmpty');
  const hasData = !!(list && list.length);
  empty.style.display = hasData ? 'none' : 'inline';

  const chronological = [...(list || [])].reverse();
  const labels = chronological.map(i => {
    try { return new Date(i.time).toLocaleTimeString(); } catch { return i.time; }
  });
  const temps = chronological.map(i => i.temperature);
  const hums = chronological.map(i => i.humidity);
  const lights = chronological.map(i => i.light ?? null);

  tempChart = createOrUpdateChart(tempChart, 'chartTemp', 'Temperature', labels, temps, '#ffb74d');
  humChart = createOrUpdateChart(humChart, 'chartHum', 'Humidity', labels, hums, '#64b5f6');
  lightChart = createOrUpdateChart(lightChart, 'chartLight', 'Light', labels, lights, '#ffd54f');
}

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
  saveHistory([]);
  renderHistory([]);
});

// Initialize history on load
let historyList = loadHistory();
renderHistory(historyList);
let lastRecorded = historyList.length ? { t: historyList[0].temperature, h: historyList[0].humidity, l: historyList[0].light } : null; // newest-first

// Light thresholds for 0‚Äì100 scale
const LIGHT_THRESHOLDS = { low: 20, high: 70 };

function updateLightUI(lightValue) {
  const indicator = document.getElementById('lightIndicator');
  const stateEl = document.getElementById('lightState');
  if (!indicator || !stateEl) return;
  const numeric = Number(lightValue);
  indicator.classList.remove('light-low', 'light-medium', 'light-high');
  indicator.style.boxShadow = '';
  indicator.style.background = '';
  let stateLabel = 'Moderate';
  if (Number.isFinite(numeric)) {
    if (numeric >= LIGHT_THRESHOLDS.high) {
      indicator.classList.add('light-high');
      stateLabel = 'Bright';
    } else if (numeric <= LIGHT_THRESHOLDS.low) {
      indicator.classList.add('light-low');
      stateLabel = 'Dark';
    } else {
      indicator.classList.add('light-medium');
      stateLabel = 'Moderate';
      const span = LIGHT_THRESHOLDS.high - LIGHT_THRESHOLDS.low;
      const frac = span > 0 ? Math.min(1, Math.max(0, (numeric - LIGHT_THRESHOLDS.low) / span)) : 0;
      const glowAlpha = 0.25 + 0.50 * frac;
      const centerAlpha = 0.45 + 0.50 * frac;
      const glowBlur = 10 + 20 * frac;
      const outerBlur = Math.round(glowBlur * 1.6);
      indicator.style.boxShadow = `0 0 ${glowBlur}px rgba(255, 215, 128, ${glowAlpha}), 0 0 ${outerBlur}px rgba(255, 215, 128, ${glowAlpha * 0.6})`;
      indicator.style.background = `radial-gradient(closest-side, rgba(255, 215, 128, ${centerAlpha}) 0%, #3a3a3a 65%, #1a1a1a 100%)`;
    }
  } else {
    indicator.classList.add('light-low');
    stateLabel = '‚Äî';
  }
  stateEl.textContent = stateLabel;
}

// ---- Smart actions thresholds & logic ----
const TEMP_THRESHOLDS = {
  comfortMin: 22,
  comfortMax: 26,
  mildCoolMin: 18,      // 18‚Äì22¬∞C: light heating suggested
  veryCold: 14,         // <= 14¬∞C: alert
  warm: 30,             // > 26‚Äì30: warm
  hot: 33,              // > 30‚Äì33: hot
  veryHot: 35,          // > 33‚Äì35: very hot
  highExtreme: 37       // >= 37¬∞C: critical alert
};
const HUMID_THRESHOLDS = { comfortMin: 35, comfortMax: 60, spikeDelta: 15 };
const NIGHT_HOURS = { start: 22, end: 6 }; // 22:00 - 06:00
let tempHighSince = null;

function isNightNow() {
  const hour = new Date().getHours();
  return NIGHT_HOURS.start > NIGHT_HOURS.end
    ? (hour >= NIGHT_HOURS.start || hour < NIGHT_HOURS.end)
    : (hour >= NIGHT_HOURS.start && hour < NIGHT_HOURS.end);
}

function evaluateSmartActions(curr, prev) {
  const actions = { temperature: [], humidity: [], light: [], combined: [], summary: [] };
  const t = Number(curr?.temperature);
  const h = Number(curr?.humidity);
  const l = Number(curr?.light);
  const prevH = Number(prev?.humidity);
  const prevL = Number(prev?.light);

  // Temperature actions (granular)
  if (Number.isFinite(t)) {
    if (t >= TEMP_THRESHOLDS.highExtreme) {
      actions.temperature.push({ text: 'Critical heat ‚Äî trigger alert notification; set AC to max cool', severity: 'alert' });
    } else if (t > TEMP_THRESHOLDS.veryHot) {
      actions.temperature.push({ text: 'Very hot ‚Äî set AC to cool (20‚Äì22¬∞C), fan high speed', severity: 'warn' });
    } else if (t > TEMP_THRESHOLDS.hot) {
      actions.temperature.push({ text: 'Hot ‚Äî turn on AC (24‚Äì26¬∞C) and close doors/windows', severity: 'warn' });
    } else if (t > TEMP_THRESHOLDS.comfortMax) {
      actions.temperature.push({ text: 'Warm ‚Äî turn on fan (medium) or AC eco mode', severity: 'info' });
    } else if (t < TEMP_THRESHOLDS.comfortMin && t >= TEMP_THRESHOLDS.mildCoolMin) {
      tempHighSince = null;
      actions.temperature.push({ text: 'Mild cool ‚Äî turn off fan; set heater low if needed', severity: 'info' });
    } else if (t < TEMP_THRESHOLDS.mildCoolMin && t > TEMP_THRESHOLDS.veryCold) {
      tempHighSince = null;
      actions.temperature.push({ text: 'Cold ‚Äî enable heater mode (moderate) and close drafts', severity: 'warn' });
    } else if (t <= TEMP_THRESHOLDS.veryCold) {
      tempHighSince = null;
      actions.temperature.push({ text: 'Extreme cold ‚Äî trigger alert; set heater to safe level', severity: 'alert' });
    } else {
      tempHighSince = null;
    }

    // Persistence check for sustained heat
    if (t > TEMP_THRESHOLDS.comfortMax) {
      if (!tempHighSince) tempHighSince = Date.now();
      else if (Date.now() - tempHighSince >= 180000) {
        actions.temperature.push({ text: 'Temperature stays high ‚Äî increase fan speed / AC mode', severity: 'warn' });
      }
    }

    // Rapid rise detection
    const prevT = Number(prev?.temperature);
    if (Number.isFinite(prevT) && t - prevT >= 2.0) {
      actions.temperature.push({ text: 'Rapid temperature rise ‚Äî check for heat sources or sunlight', severity: 'warn' });
    }
  }

  // Humidity actions
  if (Number.isFinite(h)) {
    if (h > HUMID_THRESHOLDS.comfortMax) {
      actions.humidity.push({ text: 'Turn on ventilation fan / dehumidifier', severity: 'warn' });
    } else if (h < HUMID_THRESHOLDS.comfortMin) {
      actions.humidity.push({ text: 'Turn on humidifier (or recommend manual action)', severity: 'warn' });
    }
    if (Number.isFinite(prevH) && (h - prevH) >= HUMID_THRESHOLDS.spikeDelta && h >= 70) {
      actions.humidity.push({ text: 'Abnormal spike ‚Äî send water leakage / moisture warning', severity: 'alert' });
    }
  }

  // Light actions
  if (Number.isFinite(l)) {
    if (l <= LIGHT_THRESHOLDS.low) {
      actions.light.push({ text: 'Low light detected ‚Äî turn lights ON automatically', severity: 'info' });
    } else if (l >= LIGHT_THRESHOLDS.high) {
      actions.light.push({ text: 'Bright ambient light ‚Äî turn lights OFF to save energy', severity: 'info' });
    }
    if (Number.isFinite(prevL) && isNightNow() && prevL <= LIGHT_THRESHOLDS.low && (l - prevL) >= 30 && l >= LIGHT_THRESHOLDS.high) {
      actions.light.push({ text: 'Sudden light spike at night ‚Äî trigger intrusion alert', severity: 'alert' });
    }
  }

  // Combined decisions
  if (Number.isFinite(t) && Number.isFinite(h)) {
    if (t > TEMP_THRESHOLDS.comfortMax && h > HUMID_THRESHOLDS.comfortMax) {
      actions.combined.push({ text: 'Hot + Humid ‚Äî turn on cooling + ventilation', severity: 'warn' });
    }
  }
  if (Number.isFinite(t) && Number.isFinite(l)) {
    if (t < TEMP_THRESHOLDS.comfortMin && l <= LIGHT_THRESHOLDS.low) {
      actions.combined.push({ text: 'Cool + Dark ‚Äî lights ON, fan OFF', severity: 'info' });
    }
  }

  // Summary
  const anyAlert = [...actions.temperature, ...actions.humidity, ...actions.light, ...actions.combined].some(a => a.severity === 'alert');
  if (anyAlert) {
    actions.summary.push({ text: 'Immediate attention required', severity: 'alert' });
  } else {
    const hot = Number.isFinite(t) && t > TEMP_THRESHOLDS.comfortMax;
    const cold = Number.isFinite(t) && t < TEMP_THRESHOLDS.comfortMin;
    const humid = Number.isFinite(h) && h > HUMID_THRESHOLDS.comfortMax;
    const dry = Number.isFinite(h) && h < HUMID_THRESHOLDS.comfortMin;
    const dark = Number.isFinite(l) && l <= LIGHT_THRESHOLDS.low;
    const bright = Number.isFinite(l) && l >= LIGHT_THRESHOLDS.high;
    const bits = [];
    if (hot) bits.push('cooling recommended');
    if (cold) bits.push('heating recommended');
    if (humid) bits.push('ventilation recommended');
    if (dry) bits.push('humidification recommended');
    if (dark) bits.push('lights ON suggested');
    if (bright) bits.push('lights OFF suggested');
    actions.summary.push({ text: bits.length ? bits.join(' ¬∑ ') : 'All conditions within comfort range', severity: 'info' });
  }

  return actions;
}

function renderList(containerId, items) {
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!items || !items.length) {
    el.innerHTML = '<div class="action-item ok">No action needed</div>';
    return;
  }
  el.innerHTML = items.map(a => {
    const badge = a.severity === 'alert' ? 'ALERT' : (a.severity === 'warn' ? 'ACTION' : 'INFO');
    const cls = a.severity === 'alert' ? 'severity-alert' : (a.severity === 'warn' ? 'severity-warn' : '');
    return `<div class="action-item ${cls}"><span class="badge">${badge}</span>${a.text}</div>`;
  }).join('');
}

function renderSmartActions(res) {
  renderList('smartSummary', res.summary);
  renderList('tempActions', res.temperature);
  renderList('humActions', res.humidity);
  renderList('lightActions', res.light);
  renderList('combinedActions', res.combined);
}

// ---- MQTT (HiveMQ Cloud over WebSockets) ----
const MQTT_URL = 'wss://c047bd013b954dfd8ac40154210890bf.s1.eu.hivemq.cloud:8884/mqtt';
const MQTT_OPTIONS = {
  username: 'espuser',
  password: 'Esp12345',
  keepalive: 30,
  clean: true,
  reconnectPeriod: 1500,
  connectTimeout: 8000,
  protocolVersion: 4
};

const TOPICS = ['iot/data/temperature', 'iot/data/humidity', 'iot/data/light'];

const err = document.getElementById('errorMsg');
if (err) { err.textContent = 'Connecting to MQTT‚Ä¶'; err.style.display = 'inline'; }

// Seed UI from last saved history, if available
if (historyList.length) {
  const last = historyList[0];
  if (last.temperature !== undefined) document.getElementById('temp').textContent = last.temperature + ' ¬∞C';
  if (last.humidity !== undefined) document.getElementById('hum').textContent = last.humidity + ' %';
  if (last.light !== undefined) {
    document.getElementById('light').textContent = last.light + ' %';
    updateLightUI(last.light);
  }
}

let current = {
  temperature: historyList[0]?.temperature,
  humidity: historyList[0]?.humidity,
  light: historyList[0]?.light
};

let prevValues = { temperature: current.temperature, humidity: current.humidity, light: current.light };
if (current.temperature != null && current.humidity != null) {
  renderSmartActions(evaluateSmartActions(current, prevValues));
}

let client;
try {
  client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
} catch (e) {
  if (err) { err.textContent = 'Failed to init MQTT client.'; err.style.display = 'inline'; }
}

if (client) {
  client.on('connect', () => {
    if (err) err.style.display = 'none';
    client.subscribe(TOPICS, (subErr) => {
      if (subErr && err) {
        err.textContent = 'MQTT subscribe failed. Retrying‚Ä¶';
        err.style.display = 'inline';
      }
    });
  });

  client.on('reconnect', () => {
    if (err) { err.textContent = 'MQTT reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('offline', () => {
    if (err) { err.textContent = 'MQTT offline. Reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('error', () => {
    if (err) { err.textContent = 'MQTT error. Retrying‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('message', (topic, payload) => {
    const text = payload ? payload.toString() : '';
    const num = Number(text);
    if (!Number.isFinite(num)) return;

    if (topic === 'iot/data/temperature') {
      const v = Number(num.toFixed(1));
      document.getElementById('temp').textContent = v + ' ¬∞C';
      current.temperature = v;
    } else if (topic === 'iot/data/humidity') {
      const v = Number(num.toFixed(1));
      document.getElementById('hum').textContent = v + ' %';
      current.humidity = v;
    } else if (topic === 'iot/data/light') {
      const v = Math.round(num);
      document.getElementById('light').textContent = v + ' %';
      updateLightUI(v);
      current.light = v;
    }

    // Update smart actions on every message using previous values for spike detection
    try {
      const res = evaluateSmartActions(current, prevValues);
      renderSmartActions(res);
      prevValues = { temperature: current.temperature, humidity: current.humidity, light: current.light };
    } catch (_e) { /* ignore render errors */ }

    const changed = !lastRecorded || current.temperature !== lastRecorded.t || current.humidity !== lastRecorded.h || current.light !== lastRecorded.l;
    if (changed && current.temperature != null && current.humidity != null) {
      const entry = {
        time: new Date().toISOString(),
        temperature: current.temperature,
        humidity: current.humidity,
        light: current.light
      };
      historyList = [entry, ...historyList].slice(0, MAX_HISTORY);
      saveHistory(historyList);
      renderHistory(historyList);
      lastRecorded = { t: current.temperature, h: current.humidity, l: current.light };
    }
  });
}
</script>

</body>
</html>