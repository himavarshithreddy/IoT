<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Smart Store Customer Counter</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: #0f172a; /* slate-900 */
    min-height: 100vh;
    color: #e5e7eb; /* gray-200 */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 15px;
  }
  
  h2 {
    font-size: clamp(24px, 5vw, 32px);
    font-weight: 700;
    margin-bottom: 8px;
    color: #e5e7eb;
    text-align: center;
  }
  
  .subtitle {
    margin-top: 8px;
    margin-bottom: 25px;
    font-size: clamp(12px, 3vw, 14px);
    font-weight: 500;
    color: #94a3b8;
    text-align: center;
  }
  
  .card {
    background: #111827; /* gray-900 */
    padding: clamp(24px, 5vw, 32px);
    border-radius: 20px;
    width: 100%;
    max-width: 900px;
    text-align: center;
    border: 1px solid #1f2937; /* gray-800 */
    box-shadow: 0 12px 28px rgba(0,0,0,0.35);
  }
  
  .sensor-item {
    background: #0b1220;
    padding: clamp(20px, 5vw, 28px);
    border-radius: 16px;
    margin: 12px 0;
    border: 1px solid #1f2937;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  .sensor-item p {
    font-size: clamp(13px, 3vw, 15px);
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #9ca3af; /* gray-400 */
  }
  
  .value {
    font-size: clamp(36px, 8vw, 48px);
    font-weight: 700;
    color: #e5e7eb;
    letter-spacing: -1px;
  }

  .viz {
    margin-top: 18px;
    background: #0b1220;
    border: 1px solid #1f2937;
    border-radius: 16px;
    overflow: visible;
    padding: clamp(12px, 3vw, 16px);
  }
  #scaleWrap {
    width: 100%;
    height: clamp(200px, 35vw, 280px);
  }
  #scaleSvg {
    width: 100%;
    height: 100%;
    display: block;
    overflow: visible;
  }

  #errorMsg {
    display: none;
    margin-top: 10px;
    font-size: clamp(11px, 2.5vw, 13px);
    color: #f87171;
    background: rgba(220, 38, 38, 0.12);
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 500;
    border: 1px solid rgba(220, 38, 38, 0.35);
  }

  /* Gates and event lights */
  .gate { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.4)); }
  .gate-label {
    font-size: 15px;
    font-weight: 700;
    fill: #9ca3af;
    text-anchor: middle;
  }
  .gate-post { fill: #1f2937; stroke: #3b82f6; stroke-width: 2; }
  .gate-bar  { fill: #374151; stroke: #3b82f6; stroke-width: 1.5; }
  .gate-light { fill: #4b5563; stroke: #6b7280; stroke-width: 1; }
  .gate-entry-active .gate-light { fill: #10b981; stroke: #059669; stroke-width: 2; }
  .gate-exit-active .gate-light { fill: #f59e0b; stroke: #d97706; stroke-width: 2; }
  .blink {
    animation: blinkPulse 2000ms ease-out 1;
  }
  @keyframes blinkPulse {
    0% { opacity: 0.3; filter: brightness(0.5); }
    25% { opacity: 1; filter: brightness(1.5); }
    60% { opacity: 1; filter: brightness(1.3); }
    100% { opacity: 1; filter: brightness(1); }
  }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
    margin-top: 18px;
  }
  .chart-card {
    background: #111827;
    border: 1px solid #1f2937;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  }
  .chart-title {
    font-size: clamp(12px, 3vw, 14px);
    color: #9ca3af;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 700;
  }
  canvas { width: 100% !important; height: 200px !important; }

  /* Mobile tweaks */
  @media (max-width: 768px) {
    body { padding: 20px 10px; }
    .card { 
      border-radius: 16px;
      padding: clamp(18px, 4vw, 24px);
    }
    .charts-grid {
      grid-template-columns: 1fr;
    }
    .viz {
      padding: clamp(10px, 2vw, 14px);
    }
    #scaleWrap {
      height: clamp(240px, 55vw, 320px);
    }
  }
  
  @media (max-width: 480px) {
    h2 { font-size: clamp(22px, 6vw, 26px); }
    .subtitle { font-size: clamp(11px, 3vw, 13px); }
    .sensor-item {
      flex-direction: column;
      text-align: center;
    }
    .sensor-item > div:first-child {
      text-align: center !important;
      width: 100%;
    }
    .value {
      text-align: center;
    }
    #scaleWrap {
      height: clamp(280px, 70vw, 360px);
    }
  }
</style>
</head>
<body>

<h2>üè™ Smart Store Customer Counter</h2>

<div class="subtitle">Sumanaswi Akkisetty, RA2211026010158</div>

<div class="card">
  <div class="sensor-item">
    <div style="flex: 1; text-align: left;">
      <p>Current Customers</p>
      <div id="customerVal" class="value">0</div>
    </div>
      <div style="display: flex; gap: 24px; align-items: center;">
        <div style="text-align: center;">
          <p style="font-size: 11px; margin-bottom: 4px; color: #94a3b8;">Entries Today</p>
          <div style="font-size: 24px; font-weight: 600; color: #10b981;" id="totalEntries">0</div>
        </div>
        <div style="text-align: center;">
          <p style="font-size: 11px; margin-bottom: 4px; color: #94a3b8;">Exits Today</p>
          <div style="font-size: 24px; font-weight: 600; color: #f59e0b;" id="totalExits">0</div>
        </div>
      </div>
  </div>

  <div id="scaleWrap" class="viz" aria-label="Gate visualization">
    <svg id="scaleSvg" viewBox="0 0 1100 240" preserveAspectRatio="xMidYMid meet">
      <!-- Entry Gate (left) -->
      <g id="gateEntry" class="gate">
        <rect class="gate-post" x="200" y="50" width="35" height="140" rx="6" />
        <rect class="gate-bar" x="235" y="100" width="160" height="20" rx="5" />
        <circle class="gate-light" cx="218" cy="25" r="16" />
        <text class="gate-label" x="315" y="175">ENTRY</text>
      </g>

      <!-- Exit Gate (right) -->
      <g id="gateExit" class="gate">
        <rect class="gate-post" x="865" y="50" width="35" height="140" rx="6" />
        <rect class="gate-bar" x="705" y="100" width="160" height="20" rx="5" />
        <circle class="gate-light" cx="882" cy="25" r="16" />
        <text class="gate-label" x="785" y="175">EXIT</text>
      </g>
    </svg>
  </div>

  <small id="errorMsg">Could not fetch data. Retrying‚Ä¶</small>
</div>

<div class="card" style="margin-top: 18px; max-width: 900px; width: 100%;">
  <h3 style="margin:0 0 16px 0; font-size: clamp(18px, 4vw, 22px); font-weight:700; color:#e5e7eb;">üìà Analytics Dashboard</h3>
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Customers Count</div>
      <canvas id="chartCustomers" aria-label="Customers chart"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Customer Traffic Rate (per minute)</div>
      <canvas id="chartTraffic" aria-label="Traffic rate chart"></canvas>
    </div>
  </div>
  <small style="color:#94a3b8; display:block; margin-top:12px;">Last 50 readings</small>
  <button id="clearBtn" style="margin-top:12px; background:#3b82f6; color:#ffffff; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; box-shadow: 0 6px 14px rgba(0,0,0,0.35); transition: all 0.2s ease;">Clear Data</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>

// ---- Charts state ----
const MAX_HISTORY = 50;
let customersHistory = [];
let trafficRateData = []; // {t: Date, entries: 0, exits: 0}
let customersChart, trafficChart;

function createOrUpdateChart(chartRef, canvasId, label, labels, data, color, yBounds, datasets) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return chartRef;
  if (!chartRef) {
    const chartDatasets = datasets || [{ label, data, borderColor: color, backgroundColor: color + '33', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 3 }];
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: chartDatasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { 
          legend: { 
            display: datasets ? true : false,
            labels: { color: '#94a3b8', font: { weight: 600, size: 12 } }
          }, 
          tooltip: { enabled: true, backgroundColor: 'rgba(17, 24, 39, 0.95)', borderColor: 'rgba(59, 130, 246, 0.5)', borderWidth: 1 } 
        },
        scales: {
          x: { ticks: { color: '#9ca3af', maxRotation: 0, autoSkip: true }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.06)' }, min: yBounds?.min, max: yBounds?.max, suggestedMin: yBounds?.suggestedMin, suggestedMax: yBounds?.suggestedMax }
        }
      }
    });
  } else {
    chartRef.data.labels = labels;
    if (datasets) {
      chartRef.data.datasets = datasets;
    } else {
      chartRef.data.datasets[0].data = data;
    }
    chartRef.update('none');
    return chartRef;
  }
}

function pushHistory(list, value) {
  const ts = new Date();
  list.push({ t: ts, v: value });
  if (list.length > MAX_HISTORY) list.shift();
}

function renderCharts() {
  const custLabels = customersHistory.map(i => i.t.toLocaleTimeString());
  const custData = customersHistory.map(i => i.v);
  customersChart = createOrUpdateChart(customersChart, 'chartCustomers', 'Customers', custLabels, custData, '#3b82f6', { min: 0, suggestedMax: Math.max(5, Math.ceil((Math.max(0, ...custData) + 1) / 5) * 5) });

  // Traffic rate chart: entries and exits per minute
  const trafficLabels = trafficRateData.map(i => i.t.toLocaleTimeString());
  const entriesData = trafficRateData.map(i => i.entries);
  const exitsData = trafficRateData.map(i => i.exits);
  const trafficDatasets = [
    { label: 'Entries', data: entriesData, borderColor: '#10b981', backgroundColor: '#10b98133', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 3 },
    { label: 'Exits', data: exitsData, borderColor: '#f59e0b', backgroundColor: '#f59e0b33', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 3 }
  ];
  
  // Ensure we have data or provide empty arrays
  if (trafficRateData.length === 0) {
    trafficDatasets[0].data = [0];
    trafficDatasets[1].data = [0];
    trafficLabels.push(new Date().toLocaleTimeString());
  }
  
  trafficChart = createOrUpdateChart(trafficChart, 'chartTraffic', 'Traffic', trafficLabels.length > 0 ? trafficLabels : [new Date().toLocaleTimeString()], null, null, { min: 0, suggestedMax: 5 }, trafficDatasets);
}

document.getElementById('clearBtn').addEventListener('click', () => {
  customersHistory = [];
  trafficRateData = [];
  renderCharts();
});

// ---- Gate pulse helpers ----
function pulseGate(which) {
  const entry = document.getElementById('gateEntry');
  const exit = document.getElementById('gateExit');
  if (which === 'entry' && entry) {
    entry.classList.add('gate-entry-active', 'blink');
    setTimeout(() => entry.classList.remove('gate-entry-active', 'blink'), 1200);
  } else if (which === 'exit' && exit) {
    exit.classList.add('gate-exit-active', 'blink');
    setTimeout(() => exit.classList.remove('gate-exit-active', 'blink'), 1200);
  }
}

// ---- Traffic rate tracker ----
let currentMinuteKey = '';
let currentMinuteEntries = 0;
let currentMinuteExits = 0;
let totalEntriesToday = 0;
let totalExitsToday = 0;

function getMinuteKey(date) {
  const h = date.getHours();
  const m = date.getMinutes();
  return `${h}:${m < 10 ? '0' : ''}${m}`;
}

function recordTrafficEvent(eventType) {
  const now = new Date();
  const minuteKey = getMinuteKey(now);
  
  if (minuteKey !== currentMinuteKey) {
    // New minute: push previous minute data
    if (currentMinuteKey !== '') {
      const prevTime = new Date(now);
      prevTime.setMinutes(prevTime.getMinutes() - 1);
      trafficRateData.push({ t: prevTime, entries: currentMinuteEntries, exits: currentMinuteExits });
      if (trafficRateData.length > MAX_HISTORY) trafficRateData.shift();
    }
    currentMinuteKey = minuteKey;
    currentMinuteEntries = 0;
    currentMinuteExits = 0;
  }
  
  if (eventType === 'entry') {
    currentMinuteEntries++;
    totalEntriesToday++;
    document.getElementById('totalEntries').textContent = totalEntriesToday;
  } else if (eventType === 'exit') {
    currentMinuteExits++;
    totalExitsToday++;
    document.getElementById('totalExits').textContent = totalExitsToday;
  }
}

// Initial setup: no distance scale

// ---- MQTT (HiveMQ Cloud over WebSockets) ----
const MQTT_URL = 'wss://c047bd013b954dfd8ac40154210890bf.s1.eu.hivemq.cloud:8884/mqtt';
const MQTT_OPTIONS = {
  username: 'espuser',
  password: 'Esp12345',
  keepalive: 30,
  clean: true,
  reconnectPeriod: 1500,
  connectTimeout: 8000,
  protocolVersion: 4
};

const CUSTOMERS_TOPIC = 'iot/store/customers';
const EVENT_TOPIC = 'iot/store/event';
const err = document.getElementById('errorMsg');
if (err) { err.textContent = 'Connecting to MQTT‚Ä¶'; err.style.display = 'inline'; }

let client;
try {
  client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
} catch (e) {
  if (err) { err.textContent = 'Failed to init MQTT client.'; err.style.display = 'inline'; }
}

if (client) {
  client.on('connect', () => {
    if (err) err.style.display = 'none';
    client.subscribe([CUSTOMERS_TOPIC, EVENT_TOPIC], (subErr) => {
      if (subErr && err) {
        err.textContent = 'MQTT subscribe failed. Retrying‚Ä¶';
        err.style.display = 'inline';
      }
    });
  });

  client.on('reconnect', () => {
    if (err) { err.textContent = 'MQTT reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('offline', () => {
    if (err) { err.textContent = 'MQTT offline. Reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('error', () => {
    if (err) { err.textContent = 'MQTT error. Retrying‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('message', (topic, payload) => {
    const text = payload ? payload.toString() : '';
    if (topic === CUSTOMERS_TOPIC) {
      const count = Math.max(0, parseInt(text, 10));
      if (!Number.isFinite(count)) return;
      const el = document.getElementById('customerVal');
      if (el) el.textContent = String(count);
      pushHistory(customersHistory, count);
      renderCharts();
      return;
    }
    if (topic === EVENT_TOPIC) {
      const evt = text.trim().toLowerCase();
      if (evt === 'entry') {
        pulseGate('entry');
        recordTrafficEvent('entry');
        renderCharts();
      } else if (evt === 'exit') {
        pulseGate('exit');
        recordTrafficEvent('exit');
        renderCharts();
      }
      return;
    }
  });
}

// Initial render of charts
renderCharts();

// Resize gates on mobile
function resizeGatesForMobile() {
  const isMobile = window.innerWidth <= 480;
  const entryGate = document.getElementById('gateEntry');
  const exitGate = document.getElementById('gateExit');
  if (!entryGate || !exitGate) return;

  if (isMobile) {
    // Keep both groups inside the 0..1100 viewBox
    // Entry group minX ‚âà 200 ‚Üí shift down a bit only
    entryGate.setAttribute('transform', 'translate(0,40) scale(1.15)');
    // Exit group minX ‚âà 705 ‚Üí shift left into view
    exitGate.setAttribute('transform', 'translate(-300,40) scale(1.15)');
  } else {
    // Desktop - no transforms, use original x/y coordinates
    entryGate.removeAttribute('transform');
    exitGate.removeAttribute('transform');
  }
}

// Use setTimeout to ensure SVG is rendered before getting bounding boxes
setTimeout(() => {
  window.addEventListener('resize', resizeGatesForMobile);
  resizeGatesForMobile();
}, 100);
</script>

</body>
</html>

