<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Distance Sensor Visualization</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: #0a0a0a;
    min-height: 100vh;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 15px;
  }
  
  h2 {
    font-size: clamp(22px, 5vw, 28px);
    font-weight: 600;
    margin-bottom: 8px;
    color: #ffffff;
    text-align: center;
  }
  
  .subtitle {
    margin-top: 8px;
    margin-bottom: 25px;
    font-size: clamp(12px, 3vw, 14px);
    font-weight: 500;
    color: #ffffff;
    text-align: center;
  }
  
  .card {
    background: #1a1a1a;
    padding: clamp(20px, 5vw, 30px);
    border-radius: 12px;
    width: 100%;
    max-width: 900px;
    text-align: center;
    border: 1px solid #2a2a2a;
  }
  
  .sensor-item {
    background: #242424;
    padding: clamp(16px, 4vw, 20px);
    border-radius: 8px;
    margin: 12px 0;
    border: 1px solid #333;
  }
  
  .sensor-item p {
    font-size: clamp(12px, 3vw, 14px);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #888;
  }
  
  .value {
    font-size: clamp(32px, 8vw, 42px);
    font-weight: 700;
    color: #ffffff;
    letter-spacing: -1px;
  }

  .viz {
    margin-top: 18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid #2a2a2a;
    border-radius: 10px;
    overflow: visible;
    padding: clamp(8px, 2vw, 12px);
  }
  #scaleWrap {
    width: 100%;
    height: clamp(200px, 35vw, 280px);
  }
  #scaleSvg {
    width: 100%;
    height: 100%;
    display: block;
    overflow: visible;
  }
  
  /* removed moving object styling */
  
  .legend {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    color: #aaa;
    font-size: clamp(11px, 2.5vw, 13px);
  }
  .legend .right { text-align: right; }

  #errorMsg {
    display: none;
    margin-top: 10px;
    font-size: clamp(11px, 2.5vw, 13px);
    color: #ff6b6b;
    background: #2a1a1a;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    border: 1px solid #3a2020;
  }

  /* Gates and event lights */
  .gate {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.35));
  }
  .gate-label {
    font-size: 14px;
    font-weight: 600;
    fill: rgba(255,255,255,0.8);
    text-anchor: middle;
  }
  .gate-post { fill: #2f2f2f; stroke: #555; stroke-width: 2; }
  .gate-bar  { fill: #3a3a3a; }
  .gate-light { fill: #555; }
  .gate-entry-active .gate-light { fill: #34d399; }
  .gate-exit-active .gate-light { fill: #f59e0b; }
  .blink {
    animation: blinkPulse 900ms ease-out 1;
  }
  @keyframes blinkPulse {
    0% { opacity: 0.3; transform: scale(0.9); }
    40% { opacity: 1; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Charts */
  .charts-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 18px;
  }
  .chart-card {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 12px;
  }
  .chart-title {
    font-size: clamp(12px, 3vw, 13px);
    color: #aaa;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  canvas { width: 100% !important; height: 180px !important; }

  /* Mobile tweaks */
  @media (max-width: 768px) {
    body { padding: 20px 10px; }
    .card { 
      border-radius: 10px;
      padding: clamp(16px, 4vw, 24px);
    }
    .viz {
      padding: clamp(6px, 1.5vw, 10px);
    }
    #scaleWrap {
      height: clamp(160px, 40vw, 240px);
    }
  }
  
  @media (max-width: 480px) {
    h2 { font-size: clamp(20px, 6vw, 24px); }
    .subtitle { font-size: clamp(11px, 3vw, 13px); }
    #scaleWrap {
      height: clamp(140px, 45vw, 200px);
    }
  }
</style>
</head>
<body>

<h2>üìè Distance Sensor</h2>

<div class="subtitle">Sumanaswi Akkisetty, RA2211026010158</div>

<div class="card">
  

  <div class="sensor-item">
    <p>Customers</p>
    <div id="customerVal" class="value">0</div>
  </div>

  <div id="scaleWrap" class="viz" aria-label="Gate visualization">
    <svg id="scaleSvg" viewBox="0 0 1100 180" preserveAspectRatio="xMidYMid meet">
      <!-- Entry Gate (left) -->
      <g id="gateEntry" class="gate" transform="translate(180,60)">
        <rect class="gate-post" x="-10" y="0" width="20" height="90" rx="4" />
        <rect class="gate-bar" x="10" y="20" width="90" height="12" rx="3" />
        <circle class="gate-light" cx="0" cy="-16" r="8" />
        <text class="gate-label" x="50" y="60">ENTRY</text>
      </g>

      <!-- Exit Gate (right) -->
      <g id="gateExit" class="gate" transform="translate(900,60)">
        <rect class="gate-post" x="90" y="0" width="20" height="90" rx="4" />
        <rect class="gate-bar" x="0" y="20" width="90" height="12" rx="3" />
        <circle class="gate-light" cx="110" cy="-16" r="8" />
        <text class="gate-label" x="50" y="60">EXIT</text>
      </g>

      
    </svg>
  </div>

  <small id="errorMsg">Could not fetch data. Retrying‚Ä¶</small>
</div>

<div class="card" style="margin-top: 18px; max-width: 900px; width: 100%;">
  <h3 style="margin:0 0 10px 0; font-size: clamp(18px, 4vw, 20px); font-weight:600; color:#fff;">üìà Graphs</h3>
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Customers Count</div>
      <canvas id="chartCustomers" aria-label="Customers chart"></canvas>
    </div>
  </div>
  <small style="color:#777; display:block; margin-top:8px;">Last 50 readings</small>
  <button id="clearBtn" style="margin-top:10px; background:#242424; color:#e0e0e0; border:1px solid #333; padding:6px 14px; border-radius:6px; cursor:pointer; font-weight:500; font-size:13px;">Clear</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>

// ---- Charts state ----
const MAX_HISTORY = 50;
let customersHistory = [];
let customersChart;

function createOrUpdateChart(chartRef, canvasId, label, labels, data, color, yBounds) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return chartRef;
  if (!chartRef) {
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label, data, borderColor: color, backgroundColor: color + '33', tension: 0.25, fill: true, pointRadius: 0, borderWidth: 2 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false }, tooltip: { enabled: true } },
        scales: {
          x: { ticks: { color: '#aaa', maxRotation: 0, autoSkip: true }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.06)' }, min: yBounds?.min, max: yBounds?.max, suggestedMin: yBounds?.suggestedMin, suggestedMax: yBounds?.suggestedMax }
        }
      }
    });
  } else {
    chartRef.data.labels = labels;
    chartRef.data.datasets[0].data = data;
    chartRef.update('none');
    return chartRef;
  }
}

function pushHistory(list, value) {
  const ts = new Date();
  list.push({ t: ts, v: value });
  if (list.length > MAX_HISTORY) list.shift();
}

function renderCharts() {
  const custLabels = customersHistory.map(i => i.t.toLocaleTimeString());
  const custData = customersHistory.map(i => i.v);
  customersChart = createOrUpdateChart(customersChart, 'chartCustomers', 'Customers', custLabels, custData, '#ffb74d', { min: 0, suggestedMax: Math.max(5, Math.ceil((Math.max(0, ...custData) + 1) / 5) * 5) });
}

document.getElementById('clearBtn').addEventListener('click', () => {
  customersHistory = [];
  renderCharts();
});

// ---- Gate pulse helpers ----
function pulseGate(which) {
  const entry = document.getElementById('gateEntry');
  const exit = document.getElementById('gateExit');
  if (which === 'entry' && entry) {
    entry.classList.add('gate-entry-active', 'blink');
    setTimeout(() => entry.classList.remove('gate-entry-active', 'blink'), 900);
  } else if (which === 'exit' && exit) {
    exit.classList.add('gate-exit-active', 'blink');
    setTimeout(() => exit.classList.remove('gate-exit-active', 'blink'), 900);
  }
}

// Initial setup: no distance scale

// ---- MQTT (HiveMQ Cloud over WebSockets) ----
const MQTT_URL = 'wss://c047bd013b954dfd8ac40154210890bf.s1.eu.hivemq.cloud:8884/mqtt';
const MQTT_OPTIONS = {
  username: 'espuser',
  password: 'Esp12345',
  keepalive: 30,
  clean: true,
  reconnectPeriod: 1500,
  connectTimeout: 8000,
  protocolVersion: 4
};

const CUSTOMERS_TOPIC = 'iot/store/customers';
const EVENT_TOPIC = 'iot/store/event';
const err = document.getElementById('errorMsg');
if (err) { err.textContent = 'Connecting to MQTT‚Ä¶'; err.style.display = 'inline'; }

let client;
try {
  client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
} catch (e) {
  if (err) { err.textContent = 'Failed to init MQTT client.'; err.style.display = 'inline'; }
}

if (client) {
  client.on('connect', () => {
    if (err) err.style.display = 'none';
    client.subscribe([CUSTOMERS_TOPIC, EVENT_TOPIC], (subErr) => {
      if (subErr && err) {
        err.textContent = 'MQTT subscribe failed. Retrying‚Ä¶';
        err.style.display = 'inline';
      }
    });
  });

  client.on('reconnect', () => {
    if (err) { err.textContent = 'MQTT reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('offline', () => {
    if (err) { err.textContent = 'MQTT offline. Reconnecting‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('error', () => {
    if (err) { err.textContent = 'MQTT error. Retrying‚Ä¶'; err.style.display = 'inline'; }
  });

  client.on('message', (topic, payload) => {
    const text = payload ? payload.toString() : '';
    if (topic === CUSTOMERS_TOPIC) {
      const count = Math.max(0, parseInt(text, 10));
      if (!Number.isFinite(count)) return;
      const el = document.getElementById('customerVal');
      if (el) el.textContent = String(count);
      pushHistory(customersHistory, count);
      renderCharts();
      return;
    }
    if (topic === EVENT_TOPIC) {
      const evt = text.trim().toLowerCase();
      if (evt === 'entry') pulseGate('entry');
      else if (evt === 'exit') pulseGate('exit');
      return;
    }
  });
}
</script>

</body>
</html>

